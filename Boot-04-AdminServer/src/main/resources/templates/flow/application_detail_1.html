<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>유량제어 상세 페이지</title>
    <style>
        .modal{
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            width: 50%;
            border-radius: 8px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
        }
        .close{
            float: right;
            font-size: 24px;
            cursor: pointer;
        }

        td, th{
            text-align: center;
        }
        .rateLimiter_url{
            display: none;
        }
    </style>
    <script>
        $(document).ready(function(){
            $('#openModal').on('click', function(){
                $('#myModal').css('display','block');
                $('#myModal input[type!="hidden"]').val('');
            });
            $('#createBulkhead').on('click', function(){
                $('#bulkheadModal_create').css('display', 'block');
                $('#bulkheadModal_create input[type!="hidden"]').val('');
            });
            $("#createRateLimiter").on('click', function(){
                $('#rateLimiterModal_create').css('display', 'block');
                $('#rateLimiterModal_create select').val('1');
                $('#rateLimiterModal_create input[type!="hidden"]').val('');
            })
            $('.close').on('click', function(){
                $('.modal').css('display', 'none');
            });
            $('.modal').on('click', function(event){
                if (event.target === this){
                    $('.modal').css('display', 'none');
                }
            })
            $('#rateLimiter_create_select').on('change', function(){
                let contentHTML = '<div id="rateLimiter_url_input"><p>URL 패턴</p> <label> <input type="text" name="url" required></label></div>'
                if ($(this).val() === '1'){
                    $("#rateLimiter_create_url").append(contentHTML);
                } else {
                    $("#rateLimiter_url_input").remove();
                }
            })
            // 벌크헤드 신규 등록 처리
            $('#bulkhead_create_form').on('submit', function(event){
                event.preventDefault();
                const data = {
                    'application_id': $(this).find('input[name="application_id"]').val(),
                    'url' : $(this).find('input[name="url"]').val(),
                    'maxConcurrentCalls' : $(this).find('input[name="maxConcurrentCalls"]').val(),
                    'maxWaitDuration' : $(this).find('input[name="maxWaitDuration"]').val(),
                }
                $.ajax({
                    type: 'POST',
                    url: '/admin/flow/bulkhead/create',
                    data: JSON.stringify(data),
                    contentType: 'application/json',
                    success: function(response){
                        location.reload();
                    },
                    error : function (xhr){
                        alert(xhr.responseText);
                    }
                })
            });
            //벌크헤드 업데이트
            $('#bulkhead_update_form').on('submit', function(event){
                event.preventDefault();
                const data = {
                    'id' : $(this).find('input[name="id"]').val(),
                    "application_id" : $(this).find('input[name="application_id"]').val(),
                    'url' : $(this).find('input[name="url"]').val(),
                    'maxConcurrentCalls' : $(this).find('input[name="maxConcurrentCalls"]').val(),
                    'maxWaitDuration' : $(this).find('input[name="maxWaitDuration"]').val(),
                }
                $.ajax({
                    type: 'POST',
                    url: '/admin/flow/bulkhead/update',
                    data: JSON.stringify(data),
                    contentType: 'application/json',
                    success: function(response){
                        location.reload();
                    },
                    error : function (xhr){
                        console.log(xhr.responseText);
                    }
                })
            })

            // 레이트리미터 신규 등록 처리
            $("#rateLimiter_create_form").on('submit', function(event){
                event.preventDefault();
                const data = {
                    'application_id': $(this).find('input[name="application_id"]').val(),
                    'url' : $(this).find('input[name="url"]').val(),
                    'type' : $(this).find('select[name="type"]').val(),
                    'limitForPeriod' : $(this).find('input[name="limitForPeriod"]').val(),
                    'limitRefreshPeriod' : $(this).find('input[name="limitRefreshPeriod"]').val(),
                    'timeoutDuration' : $(this).find('input[name="timeoutDuration"]').val(),
                }
                if (data.type === 1){
                    data["url"] = $(this).find('input[name="url"]').val();
                }
                $.ajax({
                    type: 'POST',
                    url: '/admin/flow/rateLimiter/create',
                    data: JSON.stringify(data),
                    contentType: 'application/json',
                    success: function(response){
                        location.reload();
                    },
                    error : function (xhr){
                        alert(xhr.responseText);
                    }
                })
            })

            $("#rateLimiter_update_form").on('submit', function(event){
                event.preventDefault();
                const data = {
                    'id' : $(this).find('input[name="id"]').val(),
                    'application_id': $(this).find('input[name="application_id"]').val(),
                    'url' : $(this).find('input[name="url"]').val(),
                    'type' : $(this).find('select[name="type"]').val(),
                    'limitForPeriod' : $(this).find('input[name="limitForPeriod"]').val(),
                    'limitRefreshPeriod' : $(this).find('input[name="limitRefreshPeriod"]').val(),
                    'timeoutDuration' : $(this).find('input[name="timeoutDuration"]').val(),
                }
                $.ajax({
                    type: 'POST',
                    url: '/admin/flow/rateLimiter/update',
                    data: JSON.stringify(data),
                    contentType: 'application/json',
                    success: function(response){
                        location.reload();
                    },
                    error : function (xhr){
                        console.log(xhr.responseText);
                    }
                })
            })

        })
        const goDelete = (button) => {
            event.stopPropagation();
            if (confirm("삭제하시겠습니까?")) {
                const id = button.getAttribute('data-id');
                const application_name = button.getAttribute('data-name');
                $.ajax({
                    type: 'GET',
                    url: '/admin/flow/bulkhead/delete?id=' + id + '&application_name=' + application_name,
                    success: function (response) {
                        alert(response);
                        location.reload();
                    },
                    error: function (xhr) {
                        alert(xhr.responseText);
                    }
                })
            }
        }

        const goDelete_rl = (button) => {
            event.stopPropagation();
            if (confirm("삭제하시겠습니까?")) {
                const id = button.getAttribute('data-id');
                const application_name = button.getAttribute('data-name');
                $.ajax({
                    type: 'GET',
                    url: '/admin/flow/rateLimiter/delete?id=' + id + '&application_name=' + application_name,
                    success: function (response) {
                        alert(response);
                        location.reload();
                    },
                    error: function (xhr) {
                        alert(xhr.responseText);
                    }
                })
            }
        };

        const goBefore = () => {
            const searchState = JSON.parse(sessionStorage.getItem("searchState"));
            const {paramPath, ...params} = searchState;
            location.href = '/admin/flow/?' + new URLSearchParams(params).toString();
        };

        const openBhUpdate = (tr) => {
            const id = tr.getAttribute('data-id');
            $.ajax({
                type: 'GET',
                url: '/admin/flow/bulkhead/find?id=' + id,
                success: function(response){
                    $('#bulkhead_update_form input[name="id"]').val(response.id);
                    $('#bulkhead_update_form input[name="url"]').val(response.url);
                    $('#bulkhead_update_form input[name="maxConcurrentCalls"]').val(parseInt(response.maxConcurrentCalls));
                    $("#bulkhead_update_form input[name='maxWaitDuration']").val(parseInt(response.maxWaitDuration));
                    $('#bulkheadModal_update').css('display', 'block');
                }
            })
        }

        const openRlUpdate = (tr) => {
            const id = tr.getAttribute('data-id');
            $.ajax({
                type: 'GET',
                url: '/admin/flow/rateLimiter/find?id=' + id,
                success: function(response){
                    $('#rateLimiter_update_form input[name="id"]').val(response.id);
                    $('#rateLimiter_update_form select[name="type"]').val(response.type);
                    $('#rateLimiter_update_form select[name="type"]').prop('disabled', true);
                    $('#rateLimiter_update_form input[name="url"]').val(response.url);
                    $('#rateLimiter_update_form input[name="limitForPeriod"]').val(parseInt(response.limitForPeriod));
                    $('#rateLimiter_update_form input[name="limitRefreshPeriod"]').val(parseInt(response.limitRefreshPeriod));
                    $('#rateLimiter_update_form input[name="timeoutDuration"]').val(parseInt(response.timeoutDuration));
                    if (response.type !== 1){
                        $('#rateLimiter_update_form input[name="url"]').prop('disabled', true);
                    } else {
                        $('#rateLimiter_update_form input[name="url"]').prop('disabled', false);
                    }
                    $('#rateLimiterModal_update').css('display', 'block');
                }
            })
        }

    </script>
</head>
<body>
<button onclick="goBefore()">뒤로가기</button>
<!-- 어플리케이션 모달 -->
<div  id="myModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h1>어플리케이션 정보 수정</h1>
        <form method="post" action="/admin/flow/updateApplication">
            <p>어플리케이션 이름</p>
            <label>
                <input type="text" placeholder="이곳에 어플리케이션 이름을 입력하세요" name="application_name" th:value="${app.applicationName}" required/>
            </label>
            <input type="hidden" name="id" th:value="${app.id}">
            <br><br>
            <div>
                <button type="submit">등록</button>
            </div>
        </form>
    </div>
</div>
<!-- 어플리케이션 모달 끝 -->
<!-- 벌크헤드 등록 모달 -->
<div id="bulkheadModal_create" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h1>동시 수행 제한 설정 등록</h1>
        <form method="post" action="/admin/flow/bulkhead/create" id="bulkhead_create_form">
            <input type="hidden" name="application_id" th:value="${app.id}">
            <p>URL 패턴</p>
            <label>
                <input type="text" name="url" placeholder="예) /product/*" required/>
            </label>
            <br><br>
            <p>최대 동시 요청</p>
            <label>
                <input type="number" name="maxConcurrentCalls" required/>
            </label>
            <br><br>
            <p>제한 초과시 대기 시간(초)</p>
            <label>
                <input type="number" name="maxWaitDuration" required/>
            </label>
            <br><br>
            <button type="submit">등록</button>
            <button type="reset">리셋</button>
        </form>
    </div>
</div>
<!-- 벌크헤드 등록 모달 끝 -->
<!-- 레이트리미터 등록 모달 -->
<div id="rateLimiterModal_create" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h1>요청 제한 설정 등록</h1>
        <form method="post" action="/admin/flow/rateLimiter/create" id="rateLimiter_create_form">
            <input type="hidden" name="application_id" th:value="${app.id}">
            <p>타입</p>
            <label>
                <select name="type" id="rateLimiter_create_select">
                    <option value="0">전체</option>
                    <option value="1" selected>url 지정</option>
                    <option value="2">접속자별</option>
                </select>
            </label>
            <br><br>
            <div id="rateLimiter_create_url">
                <div id="rateLimiter_url_input">
                    <p>URL 패턴</p>
                    <label>
                        <input type="text" name="url" placeholder="예) /product/*" required>
                    </label>
                </div>
            </div>
            <br><br>
            <p>요청 제한</p>
            <label>
                <input type="number" name="limitForPeriod">
            </label>
            <br><br>
            <p>제한 초기화 시간(초)</p>
            <label>
                <input type="number" name="limitRefreshPeriod">
            </label>
            <br><br>
            <p>제한 초과시 대기 시간(초)</p>
            <label>
                <input type="number" name="timeoutDuration">
            </label>
            <br><br>
            <button type="submit">등록</button>
            <button type="reset">리셋</button>
        </form>
    </div>
</div>
<!-- 레이트리미터 등록 모달 끝 -->
<!-- 벌크헤드 수정 모달 -->
<div id="bulkheadModal_update" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h1>동시 수행 제한 설정 수정</h1>
        <form method="post" action="/admin/flow/bulkhead/update" id="bulkhead_update_form">
            <input type="hidden" name="id">
            <input type="hidden" name="application_id" th:value="${app.id}">
            <p>URL 패턴</p>
            <label>
                <input type="text" name="url" placeholder="예) /product/*" required/>
            </label>
            <br><br>
            <p>최대 동시 요청</p>
            <label>
                <input type="number" name="maxConcurrentCalls" required/>
            </label>
            <br><br>
            <p>제한 초과시 대기 시간(초)</p>
            <label>
                <input type="number" name="maxWaitDuration" required/>
            </label>
            <br><br>
            <button type="submit">등록</button>
            <button type="reset">리셋</button>
        </form>
    </div>
</div>
<!-- 벌크헤드 수정 모달 끝 -->
<!-- 레이트리미터 수정 모달 -->
<div id="rateLimiterModal_update" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h1>요청 제한 설정 수정</h1>
        <form method="post" action="/admin/flow/rateLimiter/update" id="rateLimiter_update_form">
            <input type="hidden" name="application_id" th:value="${app.id}">
            <input type="hidden" name="id">
            <p>타입</p>
            <label>
                <select name="type" id="rateLimiter_update_select">
                    <option value="0">전체</option>
                    <option value="1" selected>url 지정</option>
                    <option value="2">접속자별</option>
                </select>
            </label>
            <br><br>
            <p>URL 패턴</p>
            <label>
                <input type="text" name="url" placeholder="예) /product/*" required>
            </label>
            <br><br>
            <p>요청 제한</p>
            <label>
                <input type="number" name="limitForPeriod">
            </label>
            <br><br>
            <p>제한 초기화 시간(초)</p>
            <label>
                <input type="number" name="limitRefreshPeriod">
            </label>
            <br><br>
            <p>제한 초과시 대기 시간(초)</p>
            <label>
                <input type="number" name="timeoutDuration">
            </label>
            <br><br>
            <button type="submit">등록</button>
            <button type="reset">리셋</button>
        </form>
    </div>
</div>
<!-- 레이트리미터 수정 끝 -->
<h1 th:text="${app.applicationName}"></h1>
<button id="openModal">수정</button>
<br><br>
<table border="1">
    <caption><b>동시 수행 제한 설정</b></caption>
    <tr>
        <td>아이디</td>
        <td>어플리케이션</td>
        <td>URL 패턴</td>
        <td>최대 동시 요청</td>
        <td>제한 초과시 대기 시간(초)</td>
        <td><button id="createBulkhead">등록</button></td>
    </tr>
    <tr th:if="${bulkheads.isEmpty()}">
        <td colspan="6">검색 결과가 없습니다.</td>
    </tr>
    <tr th:each="bulkhead:${bulkheads}" th:if="${not bulkheads.isEmpty()}" th:attr="data-id=${bulkhead.id}" onclick="openBhUpdate(this)">
        <td th:text="${bulkhead.id}"></td>
        <td th:text="${bulkhead.application_name}"></td>
        <td th:text="${bulkhead.url}"></td>
        <td th:text="${bulkhead.maxConcurrentCalls}"></td>
        <td th:text="${bulkhead.getMaxWaitDuration()}"></td>
        <td onclick="event.stopPropagation()"><button th:attr="data-id=${bulkhead.id}, data-name=${bulkhead.application_name}" onclick="goDelete(this)">삭제</button></td>
    </tr>
</table>

<br><br>

<table border="1">
    <caption><b>단위 시간당 요청 제한 설정</b></caption>
    <tr>
        <td>아이디</td>
        <td>어플리케이션</td>
        <td>타입</td>
        <td>URL 패턴</td>
        <td>요청 제한</td>
        <td>제한 초기화 시간(초)</td>
        <td>제한 초과시 대기 시간(초)</td>
        <td><button id="createRateLimiter">등록</button></td>
    </tr>
    <tr th:if="${rateLimiters.isEmpty()}">
        <td colspan="8">검색 결과가 없습니다.</td>
    </tr>
    <tr th:each="rateLimiter:${rateLimiters}" th:if="${not rateLimiters.isEmpty()}" th:attr="data-id=${rateLimiter.id}" onclick="openRlUpdate(this)">
        <td th:text="${rateLimiter.id}"></td>
        <td th:text="${rateLimiter.application_name}"></td>
        <td th:text="${rateLimiter.type}"></td>
        <td th:text="${rateLimiter.url}"></td>
        <td th:text="${rateLimiter.getLimitForPeriod()}"></td>
        <td th:text="${rateLimiter.getLimitRefreshPeriod()}"></td>
        <td th:text="${rateLimiter.getTimeOutDuration()}"></td>
        <td><button th:attr="data-id=${rateLimiter.id}, data-name=${rateLimiter.application_name}" onclick="goDelete_rl(this)">삭제</button></td>
    </tr>
</table>

</body>
</html>