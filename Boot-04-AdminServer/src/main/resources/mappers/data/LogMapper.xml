<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="neo.spider.admin.e2e.mapper.LogMapper">

    <select id="findByTraceId" parameterType="String" resultType="LogDTO">
        SELECT * FROM log
        WHERE trace_id = #{traceId}
        ORDER BY call_timestmp
    </select>

    <!-- 지연 로그 개수 조회 -->
    <select id="countDelayLogs" parameterType="LogDTO" resultType="int">
        SELECT COUNT(*) FROM log_delay
        WHERE 1=1
        <if test="ltCallTimestamp != null"> AND call_timestmp &gt;= #{ltCallTimestamp}</if>
        <if test="gtCallTimestamp != null"> And call_timestmp &lt;= #{gtCallTimestamp}</if>
        <if test="traceId != null and traceId != ''"> And trace_id LIKE CONCAT('%', #{traceId}, '%')</if>
        <if test="userId != null and userId != ''"> And user_id LIKE CONCAT('%', #{userId}, '%')</if>
        <if test="userIp != null and userIp != ''"> And user_ip LIKE CONCAT('%', #{userIp}, '%')</if>
        <if test="port != null and port != ''"> And request_url LIKE CONCAT('%', #{port}, '%')</if>
        <if test="searchExecuteTime != null"> And execution_time >= #{searchExecuteTime}</if>
    </select>

    <!-- 지연 로그 리스트 조회 -->
    <select id="findDelayLogs" resultType="LogDTO">
        SELECT * FROM log_delay
        WHERE 1=1
        <if test="paramDto.ltCallTimestamp != null"> And call_timestmp &gt;= #{paramDto.ltCallTimestamp}</if>
        <if test="paramDto.gtCallTimestamp != null"> And call_timestmp &lt;= #{paramDto.gtCallTimestamp}</if>
        <if test="paramDto.traceId != null and paramDto.traceId != ''"> And trace_id LIKE CONCAT('%', #{paramDto.traceId}, '%')</if>
        <if test="paramDto.userId != null and paramDto.userId != ''"> And user_id LIKE CONCAT('%', #{paramDto.userId}, '%')</if>
        <if test="paramDto.userIp != null and paramDto.userIp != ''"> And user_ip LIKE CONCAT('%' #{paramDto.userIp}, '%')</if>
        <if test="paramDto.port != null and paramDto.port != ''"> And request_url LIKE CONCAT('%' #{paramDto.port}, '%')</if>
        <if test="paramDto.searchExecuteTime != null"> And execution_time >= #{paramDto.searchExecuteTime}</if>
        ORDER BY call_timestmp DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 오류 로그 개수 조회 -->
    <select id="countErrorLogs" parameterType="LogDTO" resultType="int">
        SELECT COUNT(*) FROM log_error
        WHERE 1=1
        <if test="ltCallTimestamp != null"> AND call_timestmp &gt;= #{ltCallTimestamp}</if>
        <if test="gtCallTimestamp != null"> And call_timestmp &lt;= #{gtCallTimestamp}</if>
        <if test="traceId != null and traceId != ''"> And trace_id LIKE CONCAT('%', #{traceId}, '%')</if>
        <if test="userId != null and userId != ''"> And user_id LIKE CONCAT('%', #{userId}, '%')</if>
        <if test="userIp != null and userIp != ''"> And user_ip LIKE CONCAT('%', #{userIp}, '%')</if>
        <if test="port != null and port != ''"> And request_url LIKE CONCAT('%', #{port}, '%')</if>
        <if test="searchExecuteTime != null"> And execution_time >= #{searchExecuteTime}</if>
    </select>

    <!-- 오류 로그 리스트 조회 -->
    <select id="findErrorLogs" resultType="LogDTO">
        SELECT * FROM log_error
        WHERE 1=1
        <if test="paramDto.ltCallTimestamp != null"> And call_timestmp &gt;= #{paramDto.ltCallTimestamp}</if>
        <if test="paramDto.gtCallTimestamp != null"> And call_timestmp &lt;= #{paramDto.gtCallTimestamp}</if>
        <if test="paramDto.traceId != null and paramDto.traceId != ''"> And trace_id LIKE CONCAT('%', #{paramDto.traceId}, '%')</if>
        <if test="paramDto.userId != null and paramDto.userId != ''"> And user_id LIKE CONCAT('%', #{paramDto.userId}, '%')</if>
        <if test="paramDto.userIp != null and paramDto.userIp != ''"> And user_ip LIKE CONCAT('%' #{paramDto.userIp}, '%')</if>
        <if test="paramDto.port != null and paramDto.port != ''"> And request_url LIKE CONCAT('%' #{paramDto.port}, '%')</if>
        <if test="paramDto.searchExecuteTime != null"> And execution_time >= #{paramDto.searchExecuteTime}</if>
        ORDER BY call_timestmp DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>
    
    <!-- table 검색 -->
    <select id="findInfluenceLogs" resultType="LogDTO">
        SELECT * FROM log
        WHERE execution_time IS NOT NULL AND called_by NOT LIKE 'http%'
        <if test="searchType != null and searchType == 'table'">
            AND query LIKE CONCAT('%', #{searchKeyword}, '%')
        </if>
        <if test="searchType != null and searchType == 'class'">
            AND (current LIKE CONCAT('%', #{searchKeyword}, '%') OR called_by LIKE CONCAT('%', #{searchKeyword}, '%'))
            AND query is null
        </if>
        ORDER BY call_timestmp DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>
    
    <select id="countInfluenceLogs" resultType="int">
        SELECT count(*) FROM log
        WHERE execution_time IS NOT NULL AND called_by NOT LIKE 'http%'
        <if test="searchType != null and searchType == 'table'">
            AND query LIKE CONCAT('%', #{searchKeyword}, '%')
        </if>
        <if test="searchType != null and searchType == 'class'">
            AND (current LIKE CONCAT('%', #{searchKeyword}, '%') OR called_by LIKE CONCAT('%', #{searchKeyword}, '%'))
            AND query is null
        </if>
	</select>

</mapper>
